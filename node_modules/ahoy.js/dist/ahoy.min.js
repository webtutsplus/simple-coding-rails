!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).ahoy=t()}(this,function(){"use strict";function t(e){return void 0===e}function a(e){return Array.isArray(e)}function s(e){return e&&"number"==typeof e.size&&"string"==typeof e.type&&"function"==typeof e.slice}var c=function(n,i,r,o){return(i=i||{}).indices=!t(i.indices)&&i.indices,i.nullsAsUndefineds=!t(i.nullsAsUndefineds)&&i.nullsAsUndefineds,i.booleansAsIntegers=!t(i.booleansAsIntegers)&&i.booleansAsIntegers,i.allowEmptyArrays=!t(i.allowEmptyArrays)&&i.allowEmptyArrays,r=r||new FormData,t(n)||(null===n?i.nullsAsUndefineds||r.append(o,""):"boolean"==typeof n?i.booleansAsIntegers?r.append(o,n?1:0):r.append(o,n):a(n)?n.length?n.forEach(function(e,t){t=o+"["+(i.indices?t:"")+"]";c(e,i,r,t)}):i.allowEmptyArrays&&r.append(o+"[]",""):n instanceof Date?r.append(o,n.toISOString()):(e=n)!==Object(e)||s(e=n)&&"string"==typeof e.name&&("object"==typeof e.lastModifiedDate||"number"==typeof e.lastModified)||s(n)?r.append(o,n):Object.keys(n).forEach(function(e){var t=n[e];if(a(t))for(;2<e.length&&e.lastIndexOf("[]")===e.length-2;)e=e.substring(0,e.length-2);c(t,i,r,o?o+"["+e+"]":e)})),r;var e},r={serialize:c}.serialize,i={set:function(e,t,n,i){var r,o="",a="";n&&((r=new Date).setTime(r.getTime()+60*n*1e3),o="; expires="+r.toGMTString()),i&&(a="; domain="+i),document.cookie=e+"="+escape(t)+o+a+"; path=/"},get:function(e){for(var t,n=e+"=",i=document.cookie.split(";"),r=0;r<i.length;r++){for(t=i[r];" "===t.charAt(0);)t=t.substring(1,t.length);if(0===t.indexOf(n))return unescape(t.substring(n.length,t.length))}return null}},o={urlPrefix:"",visitsUrl:"/ahoy/visits",eventsUrl:"/ahoy/events",page:null,platform:"Web",useBeacon:!0,startOnReady:!0,trackVisits:!0,cookies:!0,cookieDomain:null,headers:{},visitParams:{},withCredentials:!1,visitDuration:240,visitorDuration:1051200},u=window.ahoy||window.Ahoy||{};u.configure=function(e){for(var t in e)e.hasOwnProperty(t)&&(o[t]=e[t])},u.configure(u);var n,f,d,l=window.jQuery||window.Zepto||window.$,h=!1,p=[],y="undefined"!=typeof JSON&&void 0!==JSON.stringify,v=[];function g(){return o.urlPrefix+o.eventsUrl}function m(){return(o.useBeacon||o.trackNow)&&(e=o.headers,0===Object.keys(e).length)&&y&&void 0!==window.navigator.sendBeacon&&!o.withCredentials;var e}function k(e,t,n){i.set(e,t,n,o.cookieDomain||o.domain)}function w(e){return i.get(e)}function x(e){i.set(e,"",-1)}function b(e){w("ahoy_debug")&&window.console.log(e)}function _(){for(var e;e=p.shift();)e();h=!0}function e(e,n,i){document.addEventListener(e,function(e){var t=function e(t,n){var i=t.matches||t.matchesSelector||t.mozMatchesSelector||t.msMatchesSelector||t.oMatchesSelector||t.webkitMatchesSelector;return i?i.apply(t,[n])?t:t.parentElement?e(t.parentElement,n):null:(b("Unable to match"),null)}(e.target,n);t&&i.call(t,e)})}function S(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})}function O(){o.cookies&&y&&k("ahoy_events",JSON.stringify(v),1)}function A(){var e=document.querySelector("meta[name=csrf-token]");return e&&e.content}function C(e){var t=A();t&&e.setRequestHeader("X-CSRF-Token",t)}function T(e,t,n){if(y)if(l&&l.ajax)l.ajax({type:"POST",url:e,data:JSON.stringify(t),contentType:"application/json; charset=utf-8",dataType:"json",beforeSend:C,success:n,headers:o.headers,xhrFields:{withCredentials:o.withCredentials}});else{var i,r=new XMLHttpRequest;for(i in r.open("POST",e,!0),r.withCredentials=o.withCredentials,r.setRequestHeader("Content-Type","application/json"),o.headers)o.headers.hasOwnProperty(i)&&r.setRequestHeader(i,o.headers[i]);r.onload=function(){200===r.status&&n()},C(r),r.send(JSON.stringify(t))}}function V(e){var t={events:[e]};return o.cookies&&(t.visit_token=e.visit_token,t.visitor_token=e.visitor_token),delete e.visit_token,delete e.visitor_token,t}function j(t){u.ready(function(){T(g(),V(t),function(){for(var e=0;e<v.length;e++)if(v[e].id==t.id){v.splice(e,1);break}O()})})}function P(i){u.ready(function(){var e=V(i),t=(n=document.querySelector("meta[name=csrf-param]"))&&n.content,n=A();t&&n&&(e[t]=n),e.events_json=JSON.stringify(e.events),delete e.events,window.navigator.sendBeacon(g(),r(e))})}function I(){return o.page||window.location.pathname}function D(e){return e&&0<e.length?e:null}function M(e){return function(e){for(var t in e)e.hasOwnProperty(t)&&null===e[t]&&delete e[t];return e}({tag:this.tagName.toLowerCase(),id:D(this.id),class:D(this.className),page:I(),section:function(e){for(;e&&e!==document;e=e.parentNode)if(e.hasAttribute("data-section"))return e.getAttribute("data-section");return null}(this)})}function N(){if(h=!1,n=u.getVisitId(),f=u.getVisitorId(),d=w("ahoy_track"),!1===o.cookies||!1===o.trackVisits)b("Visit tracking disabled"),_();else if(n&&f&&!d)b("Active visit"),_();else if(n||k("ahoy_visit",n=S(),o.visitDuration),w("ahoy_visit")){b("Visit started"),f||k("ahoy_visitor",f=S(),o.visitorDuration);var e,t={visit_token:n,visitor_token:f,platform:o.platform,landing_page:window.location.href,screen_width:window.screen.width,screen_height:window.screen.height,js:!0};for(e in 0<document.referrer.length&&(t.referrer=document.referrer),o.visitParams)o.visitParams.hasOwnProperty(e)&&(t[e]=o.visitParams[e]);b(t),T(o.urlPrefix+o.visitsUrl,t,function(){x("ahoy_track"),_()})}else b("Cookies disabled"),_()}u.ready=function(e){h?e():p.push(e)},u.getVisitId=u.getVisitToken=function(){return w("ahoy_visit")},u.getVisitorId=u.getVisitorToken=function(){return w("ahoy_visitor")},u.reset=function(){return x("ahoy_visit"),x("ahoy_visitor"),x("ahoy_events"),x("ahoy_track"),!0},u.debug=function(e){return!1===e?x("ahoy_debug"):k("ahoy_debug","t",525600),!0},u.track=function(e,t){var n={name:e,properties:t||{},time:(new Date).getTime()/1e3,id:S(),js:!0};return u.ready(function(){o.cookies&&!u.getVisitId()&&N(),u.ready(function(){b(n),n.visit_token=u.getVisitId(),n.visitor_token=u.getVisitorId(),m()?P(n):(v.push(n),O(),setTimeout(function(){j(n)},1e3))})}),!0},u.trackView=function(e){var t={url:window.location.href,title:document.title,page:I()};if(e)for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);u.track("$view",t)},u.trackClicks=function(){e("click","a, button, input[type=submit]",function(e){e=M.call(this,e);e.text="input"==e.tag?this.value:(this.textContent||this.innerText||this.innerHTML).replace(/[\s\r\n]+/g," ").trim(),e.href=this.href,u.track("$click",e)})},u.trackSubmits=function(){e("submit","form",function(e){e=M.call(this,e);u.track("$submit",e)})},u.trackChanges=function(){e("change","input, textarea, select",function(e){e=M.call(this,e);u.track("$change",e)})},u.trackAll=function(){u.trackView(),u.trackClicks(),u.trackSubmits(),u.trackChanges()};try{v=JSON.parse(w("ahoy_events")||"[]")}catch(e){}for(var E,U=0;U<v.length;U++)j(v[U]);return u.start=function(){N(),u.start=function(){}},E=function(){o.startOnReady&&u.start()},"interactive"===document.readyState||"complete"===document.readyState?setTimeout(E,0):document.addEventListener("DOMContentLoaded",E),u});
